# -*- coding: utf-8 -*-
"""Midterm

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1e8tqqRIfMjB6yeN-Jwy7lAAcqE2hlm64
"""

import folium
import requests
import time
import matplotlib.pyplot as plt
import base64
from io import BytesIO
from IPython.display import display, clear_output
from folium.plugins import MarkerCluster, HeatMap

# API Key t·ª´ OpenWeatherMap
API_KEY = "38c3c0e48aaee85c6a3dd868b8f3244a"

# Danh s√°ch c√°c th√†nh ph·ªë l·ªõn tr√™n th·∫ø gi·ªõi
CITIES = [
    "New York", "Los Angeles", "London", "Paris", "Berlin", "Moscow",
    "Tokyo", "Seoul", "Beijing", "Bangkok", "Dubai", "Singapore",
    "Sydney", "Mexico City", "Buenos Aires", "S√£o Paulo", "Cairo",
    "Johannesburg", "Mumbai", "Istanbul", "Toronto", "Chicago", "Jakarta"
]

# H√†m t·∫°o bi·ªÉu ƒë·ªì t·ªëc ƒë·ªô gi√≥
def create_wind_chart(wind_speeds, timestamps):
    plt.figure(figsize=(4, 2))
    plt.plot(timestamps, wind_speeds, marker="o", linestyle="-", color="blue", label="Wind Speed (km/h)")
    plt.xticks(rotation=45, fontsize=6)
    plt.yticks(fontsize=6)
    plt.xlabel("Time", fontsize=8)
    plt.ylabel("Wind Speed (km/h)", fontsize=8)
    plt.title("Wind Speed Trend", fontsize=10)
    plt.legend(fontsize=6)
    plt.grid()

    # Chuy·ªÉn bi·ªÉu ƒë·ªì th√†nh ·∫£nh base64
    buffer = BytesIO()
    plt.savefig(buffer, format="png", dpi=100)
    buffer.seek(0)
    encoded_img = base64.b64encode(buffer.getvalue()).decode()
    plt.close()

    return f'<img src="data:image/png;base64,{encoded_img}" width="200">'

# L∆∞u tr·ªØ d·ªØ li·ªáu gi√≥ theo th·ªùi gian
city_wind_data = {city: {"timestamps": [], "wind_speeds": []} for city in CITIES}

while True:
    try:
        # X√≥a m√†n h√¨nh tr∆∞·ªõc khi c·∫≠p nh·∫≠t
        clear_output(wait=True)

        # T·∫°o b·∫£n ƒë·ªì to√†n c·∫ßu
        m = folium.Map(location=[20.0, 0.0], zoom_start=2)  # Zoom xa h∆°n ƒë·ªÉ xem to√†n th·∫ø gi·ªõi
        marker_cluster = MarkerCluster().add_to(m)
        heat_data = []  # D·ªØ li·ªáu cho Heatmap

        for city in CITIES:
            # L·∫•y d·ªØ li·ªáu t·ª´ OpenWeatherMap
            URL = f"http://api.openweathermap.org/data/2.5/weather?q={city}&appid={API_KEY}&units=metric"
            response = requests.get(URL)
            data = response.json()

            if response.status_code != 200:
                print(f"L·ªói khi l·∫•y d·ªØ li·ªáu cho {city}: {data}")
                continue

            wind_speed_kph = data["wind"]["speed"] * 3.6  # Chuy·ªÉn t·ª´ m/s sang km/h
            wind_deg = data["wind"]["deg"]  # H∆∞·ªõng gi√≥ (ƒë·ªô)
            lat = data["coord"]["lat"]
            lon = data["coord"]["lon"]

            # L∆∞u d·ªØ li·ªáu gi√≥
            city_wind_data[city]["timestamps"].append(time.strftime("%H:%M:%S"))
            city_wind_data[city]["wind_speeds"].append(wind_speed_kph)

            # Gi·ªØ l·∫°i t·ªëi ƒëa 10 gi√° tr·ªã g·∫ßn nh·∫•t
            if len(city_wind_data[city]["timestamps"]) > 10:
                city_wind_data[city]["timestamps"].pop(0)
                city_wind_data[city]["wind_speeds"].pop(0)

            # T·∫°o bi·ªÉu ƒë·ªì t·ªëc ƒë·ªô gi√≥
            wind_chart = create_wind_chart(
                city_wind_data[city]["wind_speeds"],
                city_wind_data[city]["timestamps"]
            )

            # X√°c ƒë·ªãnh h∆∞·ªõng gi√≥
            wind_direction = ""
            if 337.5 <= wind_deg or wind_deg < 22.5:
                wind_direction = "‚¨ÜÔ∏è North"
            elif 22.5 <= wind_deg < 67.5:
                wind_direction = "‚ÜóÔ∏è North-East"
            elif 67.5 <= wind_deg < 112.5:
                wind_direction = "‚û°Ô∏è East"
            elif 112.5 <= wind_deg < 157.5:
                wind_direction = "‚ÜòÔ∏è South-East"
            elif 157.5 <= wind_deg < 202.5:
                wind_direction = "‚¨áÔ∏è South"
            elif 202.5 <= wind_deg < 247.5:
                wind_direction = "‚ÜôÔ∏è South-West"
            elif 247.5 <= wind_deg < 292.5:
                wind_direction = "‚¨ÖÔ∏è West"
            elif 292.5 <= wind_deg < 337.5:
                wind_direction = "‚ÜñÔ∏è North-West"

            # T·∫°o n·ªôi dung popup v·ªõi d·ªØ li·ªáu gi√≥
            popup_info = folium.Popup(
                folium.IFrame(
                    f"<b>{city}</b><br>"
                    f"üå¨Ô∏è Wind Speed: {wind_speed_kph:.1f} km/h<br>"
                    f"üß≠ Wind Direction: {wind_direction}<br>"
                    f"{wind_chart}",
                    width=250,
                    height=300
                ),
                max_width=300
            )

            # Th√™m d·ªØ li·ªáu v√†o Heatmap (t·ªëc ƒë·ªô gi√≥)
            heat_data.append([lat, lon, wind_speed_kph])

            # ƒê·ªïi m√†u bi·ªÉu t∆∞·ª£ng d·ª±a v√†o t·ªëc ƒë·ªô gi√≥
            if wind_speed_kph < 10:
                icon_color = "blue"
            elif wind_speed_kph < 20:
                icon_color = "green"
            elif wind_speed_kph < 30:
                icon_color = "orange"
            else:
                icon_color = "red"

            # Th√™m marker v√†o b·∫£n ƒë·ªì
            folium.Marker(
                location=[lat, lon],
                popup=popup_info,
                icon=folium.Icon(color=icon_color),
            ).add_to(marker_cluster)

        # Th√™m l·ªõp Heatmap v√†o b·∫£n ƒë·ªì
        HeatMap(heat_data, radius=25, blur=15).add_to(m)

        # Hi·ªÉn th·ªã b·∫£n ƒë·ªì
        display(m)

        time.sleep(30)  # C·∫≠p nh·∫≠t sau m·ªói 30 gi√¢y

    except Exception as e:
        print("Error:", e)
        break
